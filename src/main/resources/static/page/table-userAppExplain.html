<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">

        <fieldset class="table-search-fieldset">
            <legend>搜索信息</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="userName" autocomplete="off" class="layui-input">
                            </div>
                        </div>


                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary"  lay-submit lay-filter="data-search-btn"><i class="layui-icon"></i> 搜 索</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <br>
        <div class="layui-btn-container">
            <button id= "add" class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add"> 添加 </button>
        </div>


        <table id = "currentTableId" style="text-align:center"  class="layui-table"></table>
        <div id = "divPage"></div>

    </div>
</div>

<script>
    layui.use(['form', 'table','miniPage','element','laypage'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            laypage = layui.laypage,
            miniPage = layui.miniPage;


        function unique(arr){
            var hash=[];
            for (var i = 0; i < arr.length; i++) {
                if(hash.indexOf(arr[i])===-1){
                    hash.push(arr[i]);
                }
            }
            return hash;
        }

        //转义
        function escapeJquery(srcString) {
            // 转义之后的结果
            var escapseResult = srcString;

            // javascript正则表达式中的特殊字符
            var jsSpecialChars = ["\\", "^", "$", "*", "?", ".", "+", "(", ")", "[",
                "]", "|", "{", "}"];

            // jquery中的特殊字符,不是正则表达式中的特殊字符
            var jquerySpecialChars = ["~", "`", "@", "#", "%", "&", "=", "'", "\"",
                ":", ";", "<", ">", ",", "/"];

            for (var i = 0; i < jsSpecialChars.length; i++) {
                escapseResult = escapseResult.replace(new RegExp("\\"
                    + jsSpecialChars[i], "g"), "\\"
                    + jsSpecialChars[i]);
            }

            for (var i = 0; i < jquerySpecialChars.length; i++) {
                escapseResult = escapseResult.replace(new RegExp(jquerySpecialChars[i],
                    "g"), "\\" + jquerySpecialChars[i]);
            }

            return escapseResult;
        }


        function col2Row(data){
            var userList = [];
            var _clientList = [];
            var clientList;

            var list = data.page.list;

            for(var i = 0 ;i<list.length;i++){
                userList[i] = list[i].userName;
                _clientList[i] = list[i].appName;
            }

            clientList = unique(_clientList);
            var _userList = unique(userList);


            var temp = {};
            for (var j = 0; j < userList.length; j++) {
                var arr = temp[userList[j]]
                if (arr) {
                    arr.push(_clientList[j])
                } else {
                    arr = [_clientList[j]]
                }
                temp[userList[j]] = arr
            }
            console.log(temp);


            ht = "<tr><th></th>";
            for (var k = 0; k < clientList.length; k++) {
                var h = '<th>' + clientList[k] + '</th>';
                ht += h
            }
            ht += "<th>操作</th></tr>";
            for (var index in temp)  {
                ht += "<tr><td>" + index + "</td>"
                for (var m = 0; m < clientList.length; m++) {
                    if (temp[index].indexOf(clientList[m])!==-1) {
                        ht += "<td>√</td>"
                    } else {
                        ht += "<td></td>"
                    }
                }
                ht += "<td>"+
                    "<button id=\""+index+"\" class=\"layui-btn layui-btn-normal layui-btn-sm\">" + "编辑" +"</button>" +"</td></tr>"
            }
            document.getElementById("currentTableId").innerHTML += ht

            for(let n=0;n<_userList.length;n++){
                let user = escapeJquery(_userList[n]);
                $(document).on('click','#'+user,function() {
                    edit(_userList[n])
                });

            }
        }


        $(function () {
            $.ajax({
                type:"GET",
                url:"/configuration/applist/list",
                data:{ page: 1, limit: 10 },
                dataType:"json",
                success:function (res) {
                    col2Row(res);
                    laypage.render({
                        elem: 'divPage'
                        ,count: res.page.totalCount
                        ,limit:10
                        ,limits:[10,15,20,25,50,100]
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,jump: function(obj,first){
                            if (!first) {
                                $.ajax({
                                    type:"GET",
                                    url:"/configuration/applist/list",
                                    data:{ page: obj.curr, limit: obj.limit},
                                    dataType:"json",
                                    success:function (res) {
                                        document.getElementById("currentTableId").innerHTML = '';
                                        col2Row(res)
                                    }

                                });
                            }
                        }
                    });

                }

            });
        });


        // 监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            //var res = JSON.stringify(data.field);
            console.log(data.field.userName);

            $.ajax({
                type:"GET",
                url:"/configuration/applist/list",
                data:{ page: 1, limit: 10 ,userName:data.field.userName},
                dataType:"json",
                success:function (res) {
                    document.getElementById("currentTableId").innerHTML = '';
                    col2Row(res);
                    laypage.render({
                        elem: 'divPage'
                        ,count: res.page.totalCount
                        ,limit:10
                        ,limits:[10,15,20,25,50,100]
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,jump: function(obj,first){
                            if (!first) {
                                $.ajax({
                                    type:"GET",
                                    url:"/configuration/applist/list",
                                    data:{ page: obj.curr, limit: obj.limit,userName:data.field.userName},
                                    dataType:"json",
                                    success:function (res) {
                                        document.getElementById("currentTableId").innerHTML = '';
                                        col2Row(res)
                                    }

                                });
                            }
                        }
                    });



                }

            });

            return false;
        });


        //添加
        $("#add").click(function () {
            var content = miniPage.getHrefContent('page/table/add-appList.html');
            var openWH = miniPage.getOpenWidthHeight();

            var index = layer.open({
                title: '添加项目权限',
                type: 1,
                shade: 0.2,
                maxmin:true,
                shadeClose: true,
                area: [openWH[0] + 'px', openWH[1] + 'px'],
                offset: [openWH[2] + 'px', openWH[3] + 'px'],
                content: content,

                end: function(){
                    location.reload();
                }
            });
            $(window).on("resize", function () {
                layer.full(index);
            });
        });


        //edit
        function edit(userName){
            var content = miniPage.getHrefContent('page/table/edit-appList.html');
            var openWH = miniPage.getOpenWidthHeight();
            var user ={
                userName:userName
            };
            var index = layer.open({
                title: '修改项目权限',
                type: 1,
                shade: 0.2,
                maxmin:true,
                shadeClose: true,
                area: [openWH[0] + 'px', openWH[1] + 'px'],
                offset: [openWH[2] + 'px', openWH[3] + 'px'],
                content: content,
                success:function(ayero,index){
                    form.val("dataFrm",user)
                },
                end: function(){
                    location.reload();
                }
            });
            $(window).on("resize", function () {
                layer.full(index);
            });
        }



        //监听表格复选框选择
        table.on('checkbox(currentTableFilter)', function (obj) {
            console.log(obj)
        });

        table.on('tool(currentTableFilter)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') {
                $.get(""+data.appToken,function(res){
                    var content = miniPage.getHrefContent('page/table/edit-appAuthentication.html');
                    var openWH = miniPage.getOpenWidthHeight();

                    var index = layer.open({
                        title: '编辑用户',
                        type: 1,
                        shade: 0.2,
                        maxmin:true,
                        shadeClose: true,
                        area: [openWH[0] + 'px', openWH[1] + 'px'],
                        offset: [openWH[2] + 'px', openWH[3] + 'px'],
                        content: content,
                        success: function(layero,index){
                            form.val("dataFrm",res.appAuthentication)
                        },
                        end: function(){
                            //location.reload()
                            table.reload('currentTableId',{});
                        }


                    });

                    $(window).on("resize", function () {
                        layer.full(index);
                    });
                });
                return false;

            } else if (obj.event === 'delete') {
                var url = '';

                layer.confirm('真的删除行么', function (index) {

                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify([data.appToken]),
                        dataType: "json",
                        success: function (res) {
                            if (res.code == 0) {
                                layer.msg("删除成功");
                                obj.del();
                                layer.close(index);
                            }
                        },
                        error: function (res) {
                            layer.msg("删除失败");
                        }
                    });


                });
            }
        });

    });
</script>